<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JSON Builder</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<div class="tab">
  <button id = 'btnBuilder' class="tablinks active" onclick="openTab(event, 'Builder')">Builder</button>
  <button id = 'btnJSON' class="tablinks" onclick="openTab(event, 'JSON')">JSON</button>  
</div>

  <div id = "editor-container">
    <h1>Syllabus Page Builder</h1>
    <div id="editor" class="object"></div>
  </div>

  <!-- <button onclick="generateJSON()">Generate JSON</button> -->

  <div id = 'output-container'>
    <h1>JSON format</h1>
    <textarea id="output" readonly></textarea>
  </div>
  
  <script>
  
    function openTab(e, tab) {

     

      if (tab == "Builder") {
        $('#output-container').hide();
        $('#editor-container').show();
        $('#btnBuilder').addClass('active');
        $('#btnJSON').removeClass('active');
      } else {
        $('#editor-container').hide();
        $('#output-container').show();        
        $('#btnJSON').addClass('active');
        $('#btnBuilder').removeClass('active');
      }
    }

    function createPair(parent, isArray=false, first = false) {
      const pair = document.createElement("div");
      pair.className = "pair";

      const keyInput = document.createElement("input");
      if (!isArray) {        
        keyInput.placeholder = "key";
        if (first) {
          keyInput.value = "content"
        }
        pair.appendChild(keyInput);
      }

      const valueInput = document.createElement("input");
      valueInput.placeholder = "value";
      pair.appendChild(valueInput);

    
      /***
      const objBtn = document.createElement("button");
      objBtn.textContent = "Value is Object";
      objBtn.disabled = true;
      objBtn.onclick = () => {
        valueInput.remove();
        objBtn.remove();
        arrBtn.remove();
        const child = document.createElement("div");
        child.className = "object";        
        addControls(child, false);
        pair.appendChild(child);
      };
      pair.appendChild(objBtn);
      **/
      
      const arrBtn = document.createElement("button");
      arrBtn.textContent = "Content";
      arrBtn.onclick = () => {
        valueInput.remove();
        //objBtn.remove();
        arrBtn.remove();
        pair.querySelector('input').value = 'content'
        const child = document.createElement("div");
        child.className = "array";
        addArrayControls(child);
        pair.appendChild(child);
      };
      pair.appendChild(arrBtn);

      if (!first) {
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Field";
        addBtn.disabled = false;
        addBtn.onclick = (event) => {
          createPair(parent, isArray);
      }

      pair.appendChild(addBtn);
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "x";
        removeBtn.onclick = () => {
          p = pair.parentElement;          
          pair.remove();
          if (p.querySelectorAll('input').length == 0) {
            p.remove();
          }
          generateJSON();
        }

        pair.appendChild(removeBtn);
      }

      parent.appendChild(pair);

      if (isArray) {
        return valueInput;
      }

      console.log('returning...');
      return [keyInput, valueInput];
    }

    function addEmptyParagraph(container) {
      const brk = document.createElement("p");     
      container.appendChild(brk);
    }

    // hide/show all .pairs in el, which is a jQuery div.object
    function toggleHidePairs(el, type) {
      if (type == 'hide') {
        el.find('.pair').addClass('hide');
      } else {
        el.find('.pair').removeClass('hide');
      }
    }

    // returns true if last pair of inputs in a div is empty
    // event is an event in any of the inputs of the div, such as keyup
    function lastPairIsEmpty(event) {
      console.log('triggered = ' + $(event.target).val());
      const div = $(event.target).parent().parent(); 
      console.log('html = ' + div.html());

      const lastPair = div.find('div.pair').last();
      console.log('last pair = ' + lastPair.html())

      const lastInputs = lastPair.find('input');

      const values = lastInputs.map((i, el) => {
        return $(el).val().trim();   // get the input value
      }).get();  // .get() converts the jQuery-wrapped collection into a plain array

      if (values.join('') == '') {
        return true
      }

      return false
      
    }

  
    function addControls(container, isArray) {
      return createPair(container, isArray);
      return;
      //const label = document.createElement('label');
      //label.textContent ='Component';
      //container.appendChild(label);
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Field to Component #";
      addBtn.onclick = (event) => {
        createPair(container, isArray);
      }
      container.appendChild(addBtn);
      addEmptyParagraph(container);      
    }

    function addArrayControls(container) {
      addEmptyParagraph(container);
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Component";
      addBtn.onclick = () => {
        const objWrapper = document.createElement("div");
        objWrapper.className = "object";

        const collapse = document.createElement("button");
        collapse.textContent = "New component (-)";
        collapse.className = "component_header";        

        collapse.onclick = (e) => {
            const btn_text = e.target.innerHTML;
            if (btn_text.endsWith('(-)')) {             
              toggleHidePairs($(e.target.parentElement), "hide");
              e.target.innerHTML = btn_text.replace('(-)','(+)');
            } else {
              toggleHidePairs($(e.target.parentElement), "show");
              e.target.innerHTML = btn_text.replace('(+)','(-)');
            }
        };

        objWrapper.appendChild(collapse);

        //addControls(objWrapper, false);
        const textBoxes = addControls(objWrapper, false);
        container.appendChild(objWrapper);
        textBoxes[0].value = 'type';
        textBoxes[1].focus();
        generateJSON();      

      };
      container.appendChild(addBtn);
      const collapseBtn = document.createElement('button');
      collapseBtn.textContent = 'Collapse';      
      collapseBtn.onclick = (e) => {
        if (e.target.innerText == "Collapse") {            
            $(e.target.parentElement).find('.pair').addClass('hide');
            e.target.innerText = "Expand";     
            $(e.target.parentElement).find('button.component_header').each(
              function(i,e) {
                const txt = e.innerHTML;
                if (txt.endsWith('(-)')) {
                  e.innerHTML = txt.replace('(-)', '(+)');
                }                
              }
            );
            
        } else {
          $(e.target.parentElement).find('.pair').removeClass('hide');
          e.target.innerText = "Collapse";
          $(e.target.parentElement).find('button.component_header').each(
              function(i,e) {
                const txt = e.innerHTML;
                if (txt.endsWith('(+)')) {
                  e.innerHTML = txt.replace('(+)', '(-)');
                }                
              }
            );
        }
      }
      container.appendChild(collapseBtn);
      addEmptyParagraph(container);
    }

    function parseContainer(container, isArray=false) {
      const obj = isArray ? [] : {};
      const pairs = container.querySelectorAll(":scope > .pair");
      const objects = container.querySelectorAll(":scope > .object");

      if (isArray) {
        objects.forEach(childObj => {
          obj.push(parseContainer(childObj, false));
        });
      } else {
        pairs.forEach(pair => {
          const inputs = pair.querySelectorAll(":scope > input");
          const childObj = pair.querySelector(":scope > .object, :scope > .array");
          let key, value;

          key = inputs[0]?.value;
          if (!key) return; // skip empty keys
          if (childObj) {
            value = parseContainer(childObj, childObj.classList.contains("array"));
          } else {
            value = parseValue(inputs[1]?.value);
          }
          obj[key] = value;
        });
      }

      return obj;
    }

    function parseValue(val) {
      if (val === "true") return true;
      if (val === "false") return false;
      if (!isNaN(val) && val.trim() !== "") return Number(val);
      return val;
    }

    function generateJSON() {
      const root = document.getElementById("editor");
      const json = parseContainer(root, false);
      document.getElementById("output").value = JSON.stringify(json, null, 2);
    }

    // initialize
    //addControls(document.getElementById("editor"), false);
    createPair(document.getElementById('editor'), false, first = true)
    //addArrayControls(container);

$(document).ready(function() {
  //alert('ready');
  $(document).on('keyup', 'input', function() {
    generateJSON();
    //alert('change!');
  });

  $(document).on('keyup', 'input', (event) => {    
    const div = $(event.target).parent();

    // enable Add Field only if last last pair if filled
    /***
    if (lastPairIsEmpty(event)) {
       div.find('button').eq(1).prop('disabled', true);
    } else {
      div.find('button').eq(1).prop('disabled', false)
    }
    ***/

    let typeval = 'Component (-)';
    // update component button text based on type (id)
    if ($(event.target).prev().val() == 'type') {
      let v = $(event.target).val();
      if (v == '') {
        v = 'Component (unknown type) (-)';
      } else {
        v += ' (-)';
      }
      div.parent().find('button.component_header').html(v);
    }

  })

  $('button:eq(2)').click();
  $('button:eq(2)').click();
  generateJSON();
});

  </script>
</body>
</html>

