<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JSON Builder</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .object, .array { 
      border: 2px solid #ccc; 
      margin-left: 20px; 
      padding-left: 10px;
      margin-top:10px;
      margin-bottom:10px;
     }
    .pair { margin-bottom: 6px; }
    input { margin-right: 5px; }
    button { margin-left: 5px; }
    textarea { width: 100%; height: 200px; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Syllabus Page Builder</h1>
  
  <div id="editor" class="object"></div>
  <hr>
</br>

  <!-- <button onclick="generateJSON()">Generate JSON</button> -->

  <h2>JSON format</h2>
  <textarea id="output" readonly></textarea>

  <script>
    function createPair(parent, isArray=false, first = false) {
      const pair = document.createElement("div");
      pair.className = "pair";

      if (!isArray) {
        const keyInput = document.createElement("input");
        keyInput.placeholder = "key";
        if (first) {
          keyInput.value = "content"
        }
        pair.appendChild(keyInput);
      }

      const valueInput = document.createElement("input");
      valueInput.placeholder = "value";
      pair.appendChild(valueInput);

    
      /***/
      const objBtn = document.createElement("button");
      objBtn.textContent = "Value is Object";
      objBtn.disabled = true;
      objBtn.onclick = () => {
        valueInput.remove();
        objBtn.remove();
        arrBtn.remove();
        const child = document.createElement("div");
        child.className = "object";
        addControls(child, false);
        pair.appendChild(child);
      };
      pair.appendChild(objBtn);

      /****/
      

      const arrBtn = document.createElement("button");
      arrBtn.textContent = "Value is List";
      arrBtn.onclick = () => {
        valueInput.remove();
        objBtn.remove();
        arrBtn.remove();
        const child = document.createElement("div");
        child.className = "array";
        addArrayControls(child);
        pair.appendChild(child);
      };
      pair.appendChild(arrBtn);

      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Field to Component #";
      addBtn.onclick = (event) => {
        createPair(parent, isArray);
      }

      pair.appendChild(addBtn);

      if (!first) {
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "x";
        removeBtn.onclick = () => {
          pair.remove();
          generateJSON();
        }

        pair.appendChild(removeBtn);
      }

      parent.appendChild(pair);
    }

    function addEmptyParagraph(container) {
      const brk = document.createElement("p");     
      container.appendChild(brk);
    }


    // returns true if last pair of inputs in a div is empty
    // event is an event in any of the inputs of the div, such as keyup
    function lastPairIsEmpty(event) {
      console.log('triggered = ' + $(event.target).val());
      const div = $(event.target).parent().parent(); 
      console.log('html = ' + div.html());

      const lastPair = div.find('div.pair').last();
      console.log('last pair = ' + lastPair.html())

      const lastInputs = lastPair.find('input');

      const values = lastInputs.map((i, el) => {
        return $(el).val().trim();   // get the input value
      }).get();  // .get() converts the jQuery-wrapped collection into a plain array

      if (values.join('') == '') {
        return true
      }

      return false
      
    }

  
    function addControls(container, isArray) {
      
      //const label = document.createElement('label');
      //label.textContent ='Component';
      //container.appendChild(label);
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Field to Component #";
      addBtn.onclick = (event) => {
        createPair(container, isArray);
      }
      container.appendChild(addBtn);
      addEmptyParagraph(container);      
    }

    function addArrayControls(container) {
      addEmptyParagraph(container);
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Component";
      addBtn.onclick = () => {
        const objWrapper = document.createElement("div");
        objWrapper.className = "object";
        addControls(objWrapper, false);
        container.appendChild(objWrapper);
        //for (var i = 0; i < 4; i++) {
        //  container.getElementsByTagName('button')[1].click();
        //}
      };
      container.appendChild(addBtn);
      addEmptyParagraph(container);
    }

    function parseContainer(container, isArray=false) {
      const obj = isArray ? [] : {};
      const pairs = container.querySelectorAll(":scope > .pair");
      const objects = container.querySelectorAll(":scope > .object");

      if (isArray) {
        objects.forEach(childObj => {
          obj.push(parseContainer(childObj, false));
        });
      } else {
        pairs.forEach(pair => {
          const inputs = pair.querySelectorAll(":scope > input");
          const childObj = pair.querySelector(":scope > .object, :scope > .array");
          let key, value;

          key = inputs[0]?.value;
          if (!key) return; // skip empty keys
          if (childObj) {
            value = parseContainer(childObj, childObj.classList.contains("array"));
          } else {
            value = parseValue(inputs[1]?.value);
          }
          obj[key] = value;
        });
      }

      return obj;
    }

    function parseValue(val) {
      if (val === "true") return true;
      if (val === "false") return false;
      if (!isNaN(val) && val.trim() !== "") return Number(val);
      return val;
    }

    function generateJSON() {
      const root = document.getElementById("editor");
      const json = parseContainer(root, false);
      document.getElementById("output").value = JSON.stringify(json, null, 2);
    }

    // initialize
    //addControls(document.getElementById("editor"), false);
    createPair(document.getElementById('editor'), false, first = true)
    //addArrayControls(container);

$(document).ready(function() {
  //alert('ready');
  $(document).on('keyup', 'input', function() {
    generateJSON();
    //alert('change!');
  });

  $(document).on('keyup', 'input', (event) => {
    const div = $(event.target).parent().parent();
    if (lastPairIsEmpty(event)) {
       div.find('button').prop('disabled', true);
    } else {
      div.find('button').prop('disabled', false)
    }
  })

  $('button:eq(1)').click();
  $('button:first').click();
  generateJSON();
});

  </script>
</body>
</html>

